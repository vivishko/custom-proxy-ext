name: Release on tag

on:
  push:
    tags:
      - "v*"

permissions:
  actions: read
  contents: write

jobs:
  wait-for-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI Quality Gate on this tag commit
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = "CI Quality Gate";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headSha = context.sha;
            const timeoutMs = 20 * 60 * 1000;
            const intervalMs = 15000;
            const startedAt = Date.now();

            while (Date.now() - startedAt < timeoutMs) {
              const { data } = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                event: "push",
                head_sha: headSha,
                per_page: 50
              });

              const ciRuns = data.workflow_runs
                .filter((run) => run.name === workflowName)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

              if (ciRuns.length === 0) {
                core.info(`CI run not found yet for ${headSha}. Waiting...`);
                await new Promise((resolve) => setTimeout(resolve, intervalMs));
                continue;
              }

              const run = ciRuns[0];
              core.info(`Found CI run #${run.run_number}: status=${run.status}, conclusion=${run.conclusion}`);

              if (run.status !== "completed") {
                await new Promise((resolve) => setTimeout(resolve, intervalMs));
                continue;
              }

              if (run.conclusion !== "success") {
                core.setFailed(`CI Quality Gate finished with conclusion=${run.conclusion}. Release is blocked.`);
                return;
              }

              core.info("CI Quality Gate succeeded. Continuing release.");
              return;
            }

            core.setFailed("Timed out waiting for CI Quality Gate completion.");

  release:
    needs:
      - wait-for-ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Resolve release notes
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          NOTES="releases/${TAG}.md"

          if [ ! -f "$NOTES" ]; then
            echo "Release notes file not found: $NOTES" >&2
            exit 1
          fi

          echo "file=$NOTES" >> "$GITHUB_OUTPUT"

      - name: Verify package payload
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          npm run check:package -- --tag "$TAG"

      - name: Package zip
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          npm run build:package -- --tag "$TAG"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file "${{ steps.notes.outputs.file }}" \
            "custom-proxy-ext-${TAG}.zip" \
            "custom-proxy-ext-${TAG}.zip.sha256"
